# Рево Рассрочка: Плагин для 1С Битрикс 

Плагин позволяет подключить платежную систему 
рассрочки Рево к интернет-магазину битрикс. 

Модуль поставляется в кодировке Windows-1251 для совместимости с Маркетплейсом 1С-Битрикс.

## Платежная система

Модуль при установке добавляет платежную систему в интернет-магазин битрикс.
При выборе платежной системы в стандартном компоненте оформления заказа модуль 
открывает окно регистрации в РЕВО.

При оформлении заказа и переходе к оплате модуль открывает окно оформления заказа в РЕВО.

Оплатить в рассрочку на 12 месяцев возможно только 90% от заказа.

Минимальная сумма заказа должна быть при этом не менее 3 000 руб.

## Компонент Товар Детально

В стандартном компоненте детальной страницы товара модуль добавляет ссылку "Оформить рассрочку".
При нажатии на ссылку открывается окно получения лимита в РЕВО.

- [X] добавить цену ежемесячного платежа
- [X] добавить после получения лимита переход к оформлению заказа в битрикс с предустановленной платежной системой
 
## Финализация заказа

Для подтверждения заказа после одобрения и оплаты через РЕВО необходимо
перевести заказ в статус "Выполнен". При этом в РЕВО автоматически будет доставлен чек заказа для подтверждения выдачи рассрочки.

## Сниппет и компонент

Модуль предоставляет для работы с заказом сниппет и компонент "Оформить заказ в рассрочку". 
Сниппет и компонент реализуют ссылку для оформления товара в рассрочку. ID товара и ежемесячный платеж указываются 
в настройках компонента или в соответствующем тексте сниппета. Для автоматического добавления товара и перехода в корзину 
необходимо указать ID товара, его можно взять из родительского компонента или из глобального массива **\$_REQUEST**.

_! После установки модуля необходимо обновить кэш списка компонентов и сниппетов в визуальном редакторе_

![Компонент](http://revo.test-modules.tw1.ru/local/modules/revo.instalment/img/component.png)

![Сниппет](http://revo.test-modules.tw1.ru/local/modules/revo.instalment/img/snippet.png)

## Установка компонента в шаблон другого компонента

Поскольку компонент ссылки оформления рассрочки зависит от конкретного товара, лучше всего
его внедрять в шаблон компонента "catalog.element" или его аналога на вашем сайте.

Для внедрения компонента необходимо добавить в место выведения ссылки следующий код:

```php

<?$APPLICATION->IncludeComponent(
	"revo:buy.link",
	"",
	Array(
		"PRICE" => $arResult['ITEM_PRICES'][0]['BASE_PRICE'],
		"BUY_BTN_SELECTOR" => '#' . $itemIds['BUY_LINK']
	)
);?>


```

Компонент принимает два параметра 

- исходную цену, от которой будет расчитана ежемесячная оплата
- селектор кнопки оформления заказа. Скрипт автоматически произведет клик на нее после получения лимита.

## Запуск тестов

```
apt install phpunit
cd $MODULE_DIR
phpunit
```